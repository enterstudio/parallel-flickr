{if $before|@count or $after|@count}
<div class="row" style="margin: 0 auto;max-width:640px;margin-bottom:3em;" id="wrapper-{$photo.id|escape}">
		<div class="photo_before pull-left">
		{if $before|@count}
		<a href="{$owner|@flickr_urls_photos_user}{$before.0.id|escape}" title="before: {$before.0.title|truncate:30:"..."|escape}"><img src="{$before.0|@flickr_urls_photo_size:"sq"}" height="100" width="100" alt="{$before.0.title|escape}" onerror="this.src=abs_root_url + 'images/missing-n.png'; this.height=100; this.width=100;"/></a>
		{else}
		<img src="{$cfg.abs_root_url}images/youarehere.png" height="100" width="100" alt="you are here" />
		{/if}
		</div>

		<div class="photo_after pull-left">
		{if $after|@count}
		<a href="{$owner|@flickr_urls_photos_user}{$after.0.id|escape}" title="after: {$after.0.title|truncate:30:"..."|escape}"><img src="{$after.0|@flickr_urls_photo_size:"sq"}" alt="{$after.0.title|escape}"  height="100" width="100" onerror="this.src=abs_root_url + 'images/missing-n.png'; this.height=100; this.width=100;"/></a>
		{else}
		<img src="{$cfg.abs_root_url}images/youarehere.png" height="100" width="100" alt="you are here" />
		{/if}
		</div>

</div>	
{/if}

{if $is_own}

<div class="row col-md-4 col-md-offset-2">
	
	<ul>
	<li>View <a href="{$photo|@flickr_urls_photo_original}">original photo</a></li>

	{if $photo|@flickr_photos_is_on_flickr}<li>View <a href="{$photo|@flickr_urls_photo_page_flickr}" target="_flickr">photo on Flickr</a></li>{/if}

	{if $photo.hasexif}<li>View <a href="{$photo|@flickr_urls_photo_page}exif/">exif data</a></li>{/if}

	</ul>

	</div>

	<div class="row col-md-4">

	{if "photo_edit"|@features_is_enabled}
	<ul>

	{if "photo_edit_permissions"|@features_is_enabled}
	<li>Edit <a href="#edit-photo-confirm" role="button" class="xxx-btn" data-toggle="modal" title="edit the permissions for this photo" id="edit-photo" data-photo-id="{$photo.id|escape}" data-edit-crumb="{$perms_crumb|escape}">photo permissions</a>

		<div id="edit-photo-confirm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

		<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Update the permissions for this photo</h3>
		</div>

		{if !$has_write_token}

		{capture assign="redir"}{$photo|@flickr_urls_photo_page:"0"}#edit-perms{/capture}
		{include file="inc_flickr_photo_auth_request_write.txt" redir=$redir action="edit"}

		{else}

		<div class="modal-body">

			<div id="edit-photo-body">
			<select name="perms" id="edit-photo-perms">
			{foreach from=$perms_map item="label" key="id"}
				<option value="{$id|escape}"{if $id==$photo.perms} selected="true"{/if}>{$label|escape}</option>
			{/foreach}
			</select>
			</div>

			<div class="progress progress-striped active" id="edit-photo-progress" style="display:none;">
			<div class="bar" style="width: 100%;"></div>
			</div>

			{* TO DO: geo perms *}

		</div>

		<div class="modal-footer" id="edit-photo-footer">
			<button class="btn" data-dismiss="modal" id="edit-photo-dismiss" aria-hidden="true">Actually, never mind</button>
			<button class="btn btn-primary" id="edit-photo-go">Make it so</button>
		</div>

		</div>

		<script type="text/javascript">
		{literal}

		$("#edit-photo-go").click(function(e){

			var method = 'parallel.flickr.photos.setPerms';

			var e = $("#edit-photo");
			var photo_id = e.attr("data-photo-id");
			var crumb = e.attr("data-edit-crumb");

			var perms = $("#edit-photo-perms");
			perms = perms.val();

			var args = {
				'id': photo_id,
				'crumb': crumb,
				'perms': perms,
			};

			var onsuccess = function(rsp){

				if (rsp['stat'] != 'ok'){

					var err = '<p class="alert alert-error">';
					err += 'Hrmmm. The API is reporting a problem updating your photo: ';
					err += htmlspecialchars(rsp['error']['error']);
					err += '</p>';

					$("#edit-photo-body").html(err);

					$("#edit-photo-progress").hide();
					$("#edit-photo-body").show();

					setTimeout(function(){
						$("#edit-photo-confirm").modal('hide');
					}, 8000);

					return;
				}

				var feedback = '<p class="alert alert-success">';
				feedback += 'Okay! Your photo permissions have been updated.';
				feedback += '</p>';

				$("#edit-photo-body").html(feedback);

				$("#edit-photo-progress").hide();
				$("#edit-photo-body").show();

				var perms = rsp['permissions']['id'];
				var label = rsp['permissions']['label'];
				var url = rsp['permissions']['url'];

				// FIX ME... this is risky (20130728/straup)
				var link = '<a href="' + url + '">' + htmlspecialchars(label) + '</a>';

				var seenby = "it can only be seen by " + link;

				if ((perms==0) || (perms==5)){
					seenby = "it is " + link;
				}

				$("#photo-perms").html(seenby);
				$("#photo-perms-caption").html(seenby);

				setTimeout(function(){
					$("#edit-photo-confirm").modal('hide');
				}, 2000);
			};

			var onerror = function(rsp){

				var err = '<p class="alert alert-error">';
				err += 'Ack! There was a problem calling the API.';
				err += '</p>';

				$("#edit-photo-body").html(err);
				$("#edit-photo-progress").hide();
				$("#edit-photo-body").show();

				setTimeout(function(){
					$("#edit-photo-confirm").modal('hide');
				}, 8000);

			};

			parallel_flickr_api_call(method, args, onsuccess, onerror);

			$("#edit-photo-body").hide();
			$("#edit-photo-footer").hide();
			$("#edit-photo-progress").show();
		});

		{/literal}
		</script>

		{/if}

	</li>
	{/if}

	{if $photo.hasgeo and "photo_edit_geo"|@features_is_enabled}

	<li>Edit <a href="#edit-geo-confirm" role="button" class="xxx-btn" data-toggle="modal" title="edit the permissions for this photo" id="edit-geo" data-photo-id="{$photo.id|escape}" data-edit-crumb="{$perms_crumb|escape}">geo data</a>

		<div id="edit-geo-confirm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

		<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Edit the location information for this photo</h3>
		</div>

		{if !$has_write_token}

		{capture assign="redir"}{$photo|@flickr_urls_photo_page:"0"}#edit-perms{/capture}
		{include file="inc_flickr_photo_auth_request_write.txt" redir=$redir action="edit"}

		{else}

		<div class="modal-body">

			<div class="edit-geo-map-container span12">
			<div id="edit-geo-map"></div>
			<div id="edit-geo-map-crosshairs"></div>
			</div>

			<div id="edit-geo-body">
			<p><span id="edit-geo-coords" data-latitude="{$photo.latitude|escape}" data-longitude="{$photo.longitude|escape}">{$photo.latitude|escape},{$photo.longitude|escape}</span> at zoom <span id="edit-geo-zoom" data-accuracy="{$photo.accuracy|escape}">{$photo.accuracy|escape}</span></p>

			<div>
			<label for="woeid">This photo was taken in</label>
			<select name="woeid" id="woeid" data-woeid="{$photo.woeid|escape}">
				<option value="0">A place with no name</option>
			</select>
			</div>

			<div>
			<label for="geocontext">This photo was taken</label>
			<select name="geocontext" id="geocontext">
			{foreach from=$geocontext_map item="label" key="id"}
				<option value="{$id|escape}"{if $photo.geocontext==$id} selected="true"{/if}>
				{if $id==0}
				somewhere but it's not really important
				{else}
				{$label|escape}
				{/if}
				</option>
			{/foreach}
			</select>
			</div>

			</div>

			<div class="progress progress-striped active" id="edit-geo-progress" style="display:none;">
			<div class="bar" style="width: 100%;"></div>
			</div>

		</div>

		<div class="modal-footer" id="edit-geo-footer">
			<button class="btn" data-dismiss="modal" id="edit-geo-dismiss" aria-hidden="true">Actually, never mind</button>
			<button class="btn btn-primary" id="edit-geo-go">Make it so</button>
		</div>

		</div>

		<script type="text/javascript">
		{literal}

		var reverse_geocode = function(){

			var latlon = get_latlon();
			var zoom = get_zoom();

			var woeid = get_woeid();

			var method = "parallel.flickr.geo.reverseGeocode";

			var args = {
				'latitude': latlon[0],
				'longitude': latlon[1],
				'accuracy': zoom,
			};

			var onsuccess = function(rsp){

				var features = rsp['features'];

				if (features.length==0){
					// feedback goes here
					return;
				}

				var list = $("#woeid");

				for (i in features){

					var f = features[i];
					var props = f['properties'];

					var id = props['woe_id'];
					var name = props['name'];

					var item = '<option id="' + id;

					if (id==woeid){
						item += ' selected="true"';
					}

					item += '">' + name + '</option>';

					list.append(item);
				}

				// feedback goes here
			};

			parallel_flickr_api_call(method, args, onsuccess);

			// feedback goes here...
		};

		var get_latlon = function(){
			var coords = $("#edit-geo-coords");
			coords = coords.html().split(',');
			var lat = parseFloat(coords[0]);
			var lon = parseFloat(coords[1]);
			return [lat, lon];
		};

		var get_zoom = function(){
			var zoom = $("#edit-geo-zoom");
			zoom = parseInt(zoom.html());
			return zoom;
		};

		var get_geocontext = function(){

		};

		var get_woeid = function(){
			var woe = $("#woeid");
			var id = woe.attr("data-woeid");
			return id;
		};

		$(document).ready(function(){

			var update_coords = function(){
				var centroid = map.getCenter();
				var zoom = map.getZoom();

				var lat = centroid['lat'];
				var lon = centroid['lng'];

				lat = lat.toFixed(6);
				lon = lon.toFixed(6);

				$("#edit-geo-coords").html(lat + "," + lon);
				$("#edit-geo-zoom").html(zoom);
			};

			var latlon = get_latlon();
			var zoom = get_zoom();

			var args = {
				'attributionControl': false
			};

			var map = L.map('edit-geo-map', args);
			map.setView(latlon, zoom);

			map.on('move', update_coords);

			var toner = 'http://tile.stamen.com/toner-background/{z}/{x}/{y}.jpg';

			var base = L.tileLayer(toner, {
				attribution: '',
				maxZoom: 18,
				minZoom: 1
			});

			/*
			base.addTo(map);

			$("#edit-geo-map-crosshairs").dblclick(function(e){
				var offset = (e.shiftKey) ? -1 : 1;
				map.setZoom(map.getZoom() + offset);
			});
			*/
		});

		$("#edit-geo-go").click(function(e){

			reverse_geocode();
		});

		{/literal}
		</script>

		{/if}

	</li>
	{/if}

	{if "photo_edit_delete"|@features_is_enabled}
	<li>

		<a href="#delete-photo-confirm" role="button" class="btn" data-toggle="modal" title="delete this photo" id="delete-photo" data-photo-id="{$photo.id|escape}" data-delete-crumb="{$delete_crumb|escape}">Delete this photo</a>

		<div id="delete-photo-confirm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

		{if !$has_delete_token}

		{capture assign="redir"}{$photo|@flickr_urls_photo_page:"0"}#delete{/capture}
		{include file="inc_flickr_photo_auth_request_delete.txt" redir=$redir}

		{else}

		<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Delete this photo?</h3>
		</div>

		<div class="modal-body">
		{* show thumbnail here *}
		<p>There is no undo.</p>
		</div>

		<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">No, thanks</button>
		<button class="btn btn-primary" id="delete-photo-go">Yes please</button>
		</div>

		{/if}

		</div>
	</li>
	{/if}

	</ul>
	{/if}


	<!-- photo_meta -->

	{* this is not working because ... uh? bootstraup maybe? *}
	{if 0}{include file="inc_flickr_photo_map.txt"}{/if}

</div>
	{/if}

{if $is_own}
		<script type="text/javascript">
		{literal}

		$("#delete-photo-go").click(function(e){

			var method = 'parallel.flickr.photos.delete';

			var d = $("#delete-photo");
			var crumb = d.attr("data-delete-crumb");

			var args = {
				'id': photo_id,
				'crumb': crumb,
			};

			var onsuccess = function(rsp){
				console.log(rsp);
			};

			var onerror = function(rsp){
				console.log("ERROR");
				console.log(rsp);
			};

			parallel_flickr_api_call(method, args, onsuccess, onerror);

			$("#delete-photo-confirm").modal('hide');

			// hide or disabled the delete button...
			// some kind of dialog...
		});

		{/literal}
		</script>
{/if}
